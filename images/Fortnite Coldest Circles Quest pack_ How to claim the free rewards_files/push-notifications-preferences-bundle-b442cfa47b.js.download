var KeedaPushNotificationsPreferencesManagerInstance=function(){var n=GOTHAM_URL_HA_FRONTEND+"/taxonomy/cricket/names-by-ids";function e(){this.dataStorageKey="pwa_data",this.globalNotificationsStatusChangeSubscribers=[],pureJSAjaxGet("/push-notifications/templates/push_notification_helpers_preferences",function(e){document.getElementById("push-notifications-templates-container").innerHTML+=e})}function o(s,i,r,c,n,u,d){var e,t=Object.keys(c);if(!t.length)return e=$("#template__preference_empty_row"),(e=document.importNode(e.cloneNode(!0).content,!0)).querySelector(".text").innerText="You have not subscribed to any "+(r===KeedaPushNotificationsManagerInstance.ObjectType.Team?"Teams":"Series"),void i.appendChild(e);t.forEach(function(o){var e=$("#template__preference_option"),e=document.importNode(e.cloneNode(!0).content,!0),t=(e.querySelector("header.option-header").addEventListener("click",function(e){var e=e.currentTarget.parentNode,t=e.querySelector(".options"),e=e.querySelector(".option-header .option-icon > img");t.classList.contains("hidden")?(t.classList.remove("hidden"),e.src=STATIC_URL+"/assets/chevron-up.svg"):(t.classList.add("hidden"),e.src=STATIC_URL+"/assets/chevron-down.svg")},!1),e.querySelector("header.option-header .option-title").innerText=n[o],e.querySelectorAll('.options .option-row .action input[type="checkbox"]'));Array.from(t).forEach(function(e){var i,n,a,t=e.getAttribute("data-topic");c[o][t]&&(e.checked=!0),e.addEventListener("change",(i=r,n=o,a=d,function(e){var t=e.currentTarget.checked,e=e.currentTarget.getAttribute("data-topic"),e=(a&&a(i,n,e),KeedaPushNotificationsManagerInstance.generateTopic(i,n,e)),o=u.subscribedTopics;t?(o[e]=!0,KeedaPushNotificationsManagerInstance.subscribeToTopics(u.token,[e])):(delete o[e],KeedaPushNotificationsManagerInstance.unsubscribeFromTopics(u.token,[e])),s.updateSubscribedTopics(u.subscribedTopics)}),!1)}),i.appendChild(e)})}return e.prototype.getNotificationsData=function(){this.ensureLocalStorageIsAvailable();var e=window.localStorage.getItem(this.dataStorageKey),t={notifications:{allowed:!0,token:"",subscribedTopics:{}}};try{var o=JSON.parse(e);o&&o.notifications&&(t.notifications.allowed=void 0===o.notifications.allowed||o.notifications.allowed,t.notifications.token=o.notifications.token||"",t.notifications.subscribedTopics=o.notifications.subscribedTopics||{})}catch(e){console.log(e)}return t.notifications},e.prototype.updateNotificationsData=function(e){this.ensureLocalStorageIsAvailable();var t=JSON.stringify({notifications:e});return window.localStorage.setItem(this.dataStorageKey,t),this.updateNotificationsDataForSession(e),!0},e.prototype.updateNotificationsDataForSession=function(e){this.ensureSessionStorageIsAvailable();e=JSON.stringify({notifications:e});return window.sessionStorage.setItem(this.dataStorageKey,e),!0},e.prototype.doesNotificationsDataForSessionExist=function(){return this.ensureSessionStorageIsAvailable(),!!window.sessionStorage.getItem(this.dataStorageKey)},e.prototype.getToken=function(){return this.getNotificationsData().token},e.prototype.updateToken=function(e){var t=this.getNotificationsData();return t.token=e,this.updateNotificationsData(t)},e.prototype.updateTokenIfChanged=function(e){return e&&(this.getToken()!==e&&this.updateToken(e),e)},e.prototype.getSubscribedTopics=function(){return this.getNotificationsData().subscribedTopics},e.prototype.updateSubscribedTopics=function(e){var t=this.getNotificationsData();return t.subscribedTopics=e,this.updateNotificationsData(t)},e.prototype.areNotificationsAllowed=function(){return this.getNotificationsData().allowed},e.prototype.updateNotificationsAllowed=function(e){var t=this.getNotificationsData();return t.allowed=e,this.updateNotificationsData(t)},e.prototype.showNotificationsDisabledModal=function(){var e=$("#template__disabled_push_notifications_modal"),e=document.importNode(e.cloneNode(!0).content,!0);modalPopup.setContentNode(e,!0),modalPopup.setHeader("To get live match notifications, please follow the below steps"),modalPopup.setModalSize("modal_small"),modalPopup.open()},e.prototype.showManageModal=function(n){var a=this,e=$("#template__manage_notifications_modal"),t=document.importNode(e.cloneNode(!0).content,!0),s=a.getNotificationsData(),e=t.querySelector("#checkbox__notifications_allowed"),r=(e.checked=s.allowed,e.addEventListener("change",function(e){var e=e.currentTarget,t=e.checked,o=!0,i=!1;t||(confirm("You will not be able to receive any notifications from us, if you perform this action. Ready to proceed?")?i=!0:o=!(e.checked=!0)),o&&(n.onNotificationAllowedChange&&n.onNotificationAllowedChange(t),a.updateNotificationsAllowed(t),i?KeedaPushNotificationsManagerInstance.unsubscribeFromTopics(s.token,Object.keys(s.subscribedTopics)).then(function(){s.subscribedTopics={},a.updateSubscribedTopics(s.subscribedTopics)}).then(function(){a.notifySubscribersForPreferencesChanged()}).finally(function(){modalPopup.dismiss()}):a.notifySubscribersForPreferencesChanged())}),{}),c={};s.allowed||(s.subscribedTopics={}),Object.keys(s.subscribedTopics).forEach(function(e){var t=e.split("-"),o=(t[0],t[1]),i=t[2],t=t[4];e===KeedaPushNotificationsManagerInstance.generateTopic(o,t,i)&&(o===KeedaPushNotificationsManagerInstance.ObjectType.Team?(r[t]=r[t]||{},r[t][i]=!0):o===KeedaPushNotificationsManagerInstance.ObjectType.Tournament&&(c[t]=c[t]||{},c[t][i]=!0))}),this.getEntitiesNamesByIds(Object.keys(r),Object.keys(c)).then(function(e){o(a,t.querySelector("#subscribed_teams_list"),KeedaPushNotificationsManagerInstance.ObjectType.Team,r,e.teams,s,n.onPreferencesChangedForSubCategory),o(a,t.querySelector("#subscribed_series_list"),KeedaPushNotificationsManagerInstance.ObjectType.Tournament,c,e.tournaments,s,n.onPreferencesChangedForSubCategory)}).then(function(){modalPopup.setContentNode(t,!0),modalPopup.setHeader("Manage Notifications"),modalPopup.setModalSize("modal_small"),n.onModalDismissed&&modalPopup.setOnCloseHandler(n.onModalDismissed),modalPopup.open()})},e.prototype.subscribeToGlobalNotificationsStatusChange=function(e){this.globalNotificationsStatusChangeSubscribers.push(e)},e.prototype.notifySubscribersForPreferencesChanged=function(){var t=this.getNotificationsData();this.globalNotificationsStatusChangeSubscribers.forEach(function(e){e(t.allowed)})},e.prototype.fetchAndPersistSubscribedTopicsForSession=function(e){if(!e)return Promise.resolve();if(this.doesNotificationsDataForSessionExist())return Promise.resolve();var o=this;return KeedaPushNotificationsManagerInstance.getSubscribedTopics(e,!0).then(function(e){var t={};e.forEach(function(e){t[e]=!0}),o.updateSubscribedTopics(t)}).catch(function(e){console.info("Error while fetching subscribed topics ",e)})},e.prototype.ensureLocalStorageIsAvailable=function(){if(!1 in window)throw new Error("Local storage is not available!")},e.prototype.ensureSessionStorageIsAvailable=function(){if(!1 in window)throw new Error("Session storage is not available!")},e.prototype.getEntitiesNamesByIds=function(o,i){return new Promise(function(t,e){pureJSAjaxPost(n,{teams:(o||[]).map(Number),tournaments:(i||[]).map(Number)},function(e){e=e?JSON.parse(e):{};t(e)},e,null,!0)})},new e}();